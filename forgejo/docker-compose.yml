services:

  ################################################################################
  server:
    container_name: forgejo
    restart: unless-stopped
    # for podman:
    # userns_mode: keep-id
    image: codeberg.org/forgejo/forgejo:12-rootless
    build:
      context: .
      dockerfile: Dockerfile
    env_file: .env
    volumes:
      - type: bind
        bind:
          create_host_path: false
        source: ./data/git
        target: /var/lib/gitea
      - type: bind
        bind:
          create_host_path: false
        source: /etc/timezone
        target: /etc/timezone
        read_only: true
      - type: bind
        bind:
          create_host_path: false
        source: /etc/localtime
        target: /etc/localtime
        read_only: true
    networks:
      - forgejo
    ports:
      - "127.0.0.1:3000:3000"
      - "127.0.0.1:2222:2222"

  ################################################################################
  db:
    container_name: forgejo-db
    restart: unless-stopped
    # for podman:
    # userns_mode: keep-id
    image: oci.guero.org/postgres:latest
    env_file: .env
    volumes:
      - type: bind
        bind:
          create_host_path: false
        source: ./data/db
        target: /var/lib/postgresql/data
    networks:
      - forgejo
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 45s

networks:
  forgejo:
    external: false
    # name:
